<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voting Ketua</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      background: #f5f7fa;
      color: #222;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(20, 20, 40, 0.08);
      width: 100%;
      max-width: 600px;
    }

    .center {
      text-align: center;
    }

    .hidden {
      display: none;
    }

    form input[type="text"] {
      width: 100%;
      padding: 12px 10px;
      font-size: 16px;
      border: 1px solid #ccd;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      background: #0b74da;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: 0.2s;
    }

    .btn:hover {
      background: #095eb4;
    }

    .btn.secondary {
      background: #777;
    }

    .btn.secondary:hover {
      background: #555;
    }

    .candidates {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 18px;
    }

    .candidate {
      background: #fafbff;
      border: 1px solid #e6eaf2;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.12s, box-shadow 0.12s;
    }

    .candidate.selected {
      outline: 3px solid #cfe6ff;
      transform: translateY(-6px);
      box-shadow: 0 10px 30px rgba(10, 80, 180, 0.08);
    }

    .candidate img {
      width: 100%;
      max-width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 8px;
      margin: 0 auto 8px;
    }

    .footer {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .small {
      font-size: 13px;
      color: #666;
    }

    /* Responsive tweak */
    @media (max-width: 480px) {
      h2, h3 {
        font-size: 1.2em;
      }

      .btn {
        width: 100%;
        text-align: center;
        margin-top: 8px;
      }

      .footer {
        flex-direction: column;
        align-items: stretch;
      }

      .card {
        padding: 16px;
      }

      .candidate img {
        max-width: 90px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="card" id="app">
    <div id="nameScreen">
      <h2 class="center">Selamat datang</h2>
      <p class="center small">Masukkan nama Anda untuk mulai memilih ketua.</p>
      <form id="nameForm" onsubmit="return submitName(event)">
        <input
          type="text"
          id="voterName"
          placeholder="Nama lengkap"
          required
          maxlength="60"
        />
        <div style="margin-top: 12px; text-align: right;">
          <button class="btn" type="submit">Mulai Voting</button>
        </div>
      </form>
    </div>

    <div id="voteScreen" class="hidden">
      <h3>Pilih Calon Ketua</h3>
      <p class="small" id="greeting"></p>

      <div class="candidates" id="candidates"></div>

      <div class="footer">
        <div class="small">Pilih 1 kandidat lalu klik "Voting".</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn secondary" onclick="goBack()">Ubah Nama</button>
          <button class="btn" id="voteBtn" onclick="submitVote()" disabled>
            Voting
          </button>
        </div>
      </div>
    </div>

    <div id="confirmScreen" class="hidden">
      <h3>Konfirmasi Suara</h3>
      <p class="small" id="confirmText"></p>
      <div
        style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;"
      >
        <button class="btn secondary" onclick="cancelConfirm()">Batal</button>
        <button class="btn" onclick="confirmVote()">
          Konfirmasi & Kirim
        </button>
      </div>
    </div>

    <div id="thankYou" class="hidden center">
      <h3>Terima kasih!</h3>
      <p class="small" id="thankText"></p>
    </div>
  </div>

<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/xxxxxx"; // ganti dengan URL SheetDB kamu

const candidatesData = [
  { id: 'c1', name: 'Ahmad Santoso', photo: 'https://via.placeholder.com/300x300.png?text=Ahmad' },
  { id: 'c2', name: 'Siti Maria', photo: 'https://via.placeholder.com/300x300.png?text=Siti' },
  { id: 'c3', name: 'Budi Prasetyo', photo: 'https://via.placeholder.com/300x300.png?text=Budi' },
  { id: 'c4', name: 'Rina Kusuma', photo: 'https://via.placeholder.com/300x300.png?text=Rina' }
];

const nameScreen = document.getElementById('nameScreen');
const voteScreen = document.getElementById('voteScreen');
const confirmScreen = document.getElementById('confirmScreen');
const thankYou = document.getElementById('thankYou');
const greeting = document.getElementById('greeting');
const candidatesEl = document.getElementById('candidates');
const voteBtn = document.getElementById('voteBtn');
const confirmText = document.getElementById('confirmText');
const thankText = document.getElementById('thankText');

let voter = { name: '', choice: null };

async function submitName(e) {
  e.preventDefault();
  const input = document.getElementById('voterName');
  const val = input.value.trim();

  if (!val) return false;

  // --- CEK APAKAH NAMA SUDAH ADA DI DATABASE ---
  const res = await fetch(`${SHEETDB_URL}/search?voter=${encodeURIComponent(val)}`);
  const data = await res.json();

  if (data.length > 0) {
    alert("Nama ini sudah pernah digunakan untuk voting. Satu orang hanya boleh voting sekali!");
    input.value = "";
    return false;
  }

  voter.name = val;
  nameScreen.classList.add('hidden');
  renderCandidates();
  greeting.textContent = `Halo, ${voter.name}. Silakan pilih salah satu calon di bawah.`;
  voteScreen.classList.remove('hidden');
  return false;
}

function renderCandidates() {
  candidatesEl.innerHTML = '';
  candidatesData.forEach(c => {
    const div = document.createElement('div');
    div.className = 'candidate';
    div.dataset.id = c.id;
    div.innerHTML = `
      <img src="${c.photo}" alt="${c.name}" />
      <div style="font-weight:600;">${c.name}</div>
    `;
    div.onclick = () => selectCandidate(c.id, div);
    candidatesEl.appendChild(div);
  });
  voteBtn.disabled = true;
  voter.choice = null;
}

function selectCandidate(id, el) {
  document.querySelectorAll('.candidate').forEach(card => card.classList.remove('selected'));
  el.classList.add('selected');
  voter.choice = candidatesData.find(c => c.id === id);
  voteBtn.disabled = false;
}

function submitVote() {
  if (!voter.choice) return;
  voteScreen.classList.add('hidden');
  confirmText.innerHTML = `Nama pemilih: <strong>${escapeHtml(voter.name)}</strong><br/>Calon yang dipilih: <strong>${escapeHtml(voter.choice.name)}</strong>`;
  confirmScreen.classList.remove('hidden');
}

function cancelConfirm() {
  confirmScreen.classList.add('hidden');
  voteScreen.classList.remove('hidden');
}

async function confirmVote() {
  // kirim data ke SheetDB
  await fetch(SHEETDB_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      data: [{ voter: voter.name, choiceId: voter.choice.id, choiceName: voter.choice.name, time: new Date().toISOString() }]
    })
  });

  confirmScreen.classList.add('hidden');
  thankText.innerHTML = `Suara Anda untuk <strong>${escapeHtml(voter.choice.name)}</strong> telah diterima.`;
  thankYou.classList.remove('hidden');

  setTimeout(() => {
    document.getElementById('app').innerHTML = `
      <div class="center">
        <h3>Terima kasih, ${escapeHtml(voter.name)}!</h3>
        <p class="small">Suara Anda telah dicatat.</p>
      </div>
    `;
  }, 1600);
}

function goBack() {
  voteScreen.classList.add('hidden');
  nameScreen.classList.remove('hidden');
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
}
</script>
</body>
</html>
